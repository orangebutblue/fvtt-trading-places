<!DOCTYPE html>
<html>
<head>
    <title>Trading Places Emergency Reset</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .error { color: red; background: #ffe6e6; padding: 15px; border-radius: 5px; border-left: 4px solid #cc0000; margin: 10px 0; }
        .success { color: green; background: #e6ffe6; padding: 15px; border-radius: 5px; border-left: 4px solid #00aa00; margin: 10px 0; }
        .info { background: #e6f3ff; padding: 15px; border-radius: 5px; border-left: 4px solid #0066cc; margin: 10px 0; }
        .warning { color: #aa6600; background: #fff3cd; padding: 15px; border-radius: 5px; border-left: 4px solid #aa6600; margin: 10px 0; }
        button { padding: 12px 24px; margin: 8px; cursor: pointer; border: none; border-radius: 5px; font-size: 16px; }
        .primary { background: #007bff; color: white; }
        .primary:hover { background: #0056b3; }
        .danger { background: #dc3545; color: white; }
        .danger:hover { background: #c82333; }
        .success-btn { background: #28a745; color: white; }
        .success-btn:hover { background: #218838; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6; overflow-x: auto; margin: 10px 0; }
        h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        h2 { color: #555; margin-top: 30px; }
        .status { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® Trading Places Emergency Reset Tool</h1>

        <div class="error">
            <strong>CRITICAL ISSUE:</strong> Your Trading Places module is configured to load a dataset called 'new1' that doesn't exist or is corrupted. This is causing startup validation failures.
        </div>

        <div class="info">
            <strong>What I've Done:</strong> I've created a minimal 'new1' dataset with proper structure so your module can start without errors. However, you should reset to use the default WFRP4e dataset.
        </div>

        <h2>üîß Step 1: Reset Active Dataset</h2>
        <p>Open your browser's developer console (F12) in FoundryVTT and run this command:</p>
        <pre>game.settings.set("fvtt-trading-places", "activeDataset", "wfrp4e")</pre>
        <button class="primary" onclick="resetDataset()">Reset to WFRP4e Dataset</button>

        <h2>üßπ Step 2: Clear Corrupted User Data (Optional)</h2>
        <p>If you created custom datasets that are causing issues, clear them:</p>
        <pre>
game.settings.set("fvtt-trading-places", "userDatasets", []);
game.settings.set("fvtt-trading-places", "userDatasetsData", {});
        </pre>
        <button class="danger" onclick="clearUserDatasets()">Clear All User Datasets</button>

        <h2>‚úÖ Step 3: Verify Fix</h2>
        <p>After running the reset, refresh your FoundryVTT page. The validation errors should disappear.</p>
        <button class="success-btn" onclick="checkStatus()">Check Current Status</button>

        <div class="warning">
            <strong>Note:</strong> The module has partial support for D&D 5e. You may see warnings about this, but the core trading functionality should work. If you need full D&D 5e support, consider switching back to WFRP4e or waiting for future updates.
        </div>

        <div class="status" id="status">
            <strong>Status:</strong> Click "Check Current Status" to verify your settings.
        </div>
    </div>

    <script>
        async function checkStatus() {
            const statusDiv = document.getElementById('status');

            try {
                if (typeof game === 'undefined' || !game.settings) {
                    statusDiv.innerHTML = '<strong>‚ùå Error:</strong> Not running in FoundryVTT environment. Please open this in your FoundryVTT browser window.';
                    return;
                }

                const activeDataset = await game.settings.get("fvtt-trading-places", "activeDataset");
                const userDatasets = await game.settings.get("fvtt-trading-places", "userDatasets") || [];

                let statusHtml = '<strong>‚úÖ Status Check Complete:</strong><br>';
                statusHtml += `Active Dataset: <code>${activeDataset || 'Not set (using default)'}</code><br>`;
                statusHtml += `User Datasets: <code>${userDatasets.length > 0 ? userDatasets.join(', ') : 'None'}</code><br>`;

                if (activeDataset === 'wfrp4e') {
                    statusHtml += '<br><span style="color: green;">‚úì Configuration looks correct!</span>';
                } else if (activeDataset === 'new1') {
                    statusHtml += '<br><span style="color: orange;">‚ö†Ô∏è Still set to new1 - run the reset command above.</span>';
                } else {
                    statusHtml += '<br><span style="color: blue;">‚ÑπÔ∏è Custom dataset detected.</span>';
                }

                statusDiv.innerHTML = statusHtml;
            } catch (error) {
                statusDiv.innerHTML = `<strong>‚ùå Error checking status:</strong> ${error.message}`;
            }
        }

        async function resetDataset() {
            const statusDiv = document.getElementById('status');

            try {
                if (typeof game === 'undefined' || !game.settings) {
                    alert('Not running in FoundryVTT environment. Please open this in your FoundryVTT browser window.');
                    return;
                }

                await game.settings.set("fvtt-trading-places", "activeDataset", "wfrp4e");
                statusDiv.innerHTML = '<strong>‚úÖ Success:</strong> Active dataset reset to "wfrp4e". Please refresh your FoundryVTT page.';
                alert('Dataset reset complete! Please refresh your FoundryVTT page.');
            } catch (error) {
                statusDiv.innerHTML = `<strong>‚ùå Error resetting dataset:</strong> ${error.message}`;
                alert('Error resetting dataset: ' + error.message);
            }
        }

        async function clearUserDatasets() {
            const statusDiv = document.getElementById('status');

            if (!confirm('This will permanently delete all your custom datasets. Are you sure?')) {
                return;
            }

            try {
                if (typeof game === 'undefined' || !game.settings) {
                    alert('Not running in FoundryVTT environment. Please open this in your FoundryVTT browser window.');
                    return;
                }

                await game.settings.set("fvtt-trading-places", "userDatasets", []);
                await game.settings.set("fvtt-trading-places", "userDatasetsData", {});
                await game.settings.set("fvtt-trading-places", "activeDataset", "wfrp4e");

                statusDiv.innerHTML = '<strong>‚úÖ Success:</strong> All user datasets cleared and active dataset reset to "wfrp4e". Please refresh your FoundryVTT page.';
                alert('User datasets cleared! Please refresh your FoundryVTT page.');
            } catch (error) {
                statusDiv.innerHTML = `<strong>‚ùå Error clearing user datasets:</strong> ${error.message}`;
                alert('Error clearing user datasets: ' + error.message);
            }
        }

        // Auto-check status on load if in FoundryVTT
        if (typeof game !== 'undefined' && game.settings) {
            setTimeout(checkStatus, 1000);
        }
    </script>
</body>
</html>