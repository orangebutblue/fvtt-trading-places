{{!-- Enhanced Trading Dialog Template with Orange Realism Features --}}
<div class="wfrp-trading-dialog enhanced">
    {{!-- Settlement Header Panel --}}
    <div class="settlement-header-panel">
        <div class="settlement-basic-info">
            <h2 class="settlement-name">{{settlement.name}}</h2>
            <div class="settlement-meta">
                <span class="settlement-region">{{settlement.region}}</span>
                <span class="settlement-size" title="Population: {{settlement.population}}">
                    Size {{settlement.size}} ({{getSizeName settlement.size}})
                </span>
                <span class="settlement-wealth" title="Wealth Level">
                    {{getWealthName settlement.wealth}}
                </span>
            </div>
        </div>
        
        <div class="settlement-economic-profile">
            {{#if settlement.flags}}
            <div class="settlement-flags">
                <label>Flags:</label>
                {{#each settlement.flags}}
                <span class="flag-badge" title="{{getFlagDescription this}}">{{this}}</span>
                {{/each}}
            </div>
            {{/if}}
            
            <div class="settlement-trade-profile">
                {{#if settlement.produces}}
                <div class="produces-section">
                    <label>Produces:</label>
                    <span class="trade-items">{{join settlement.produces ", "}}</span>
                </div>
                {{/if}}
                {{#if settlement.demands}}
                <div class="demands-section">
                    <label>Demands:</label>
                    <span class="trade-items">{{join settlement.demands ", "}}</span>
                </div>
                {{/if}}
            </div>
        </div>
        
        <div class="settlement-actions">
            <button class="data-editor-btn" title="Edit Settlement Data">
                <i class="fas fa-edit"></i> Edit Data
            </button>
            <button class="generate-availability-btn" title="Generate Merchant Availability">
                <i class="fas fa-dice"></i> Check Availability
            </button>
        </div>
    </div>

    {{!-- Equilibrium Summary Strip --}}
    <div class="equilibrium-summary">
        <h3>Supply & Demand Overview</h3>
        <div class="equilibrium-bars">
            {{#each cargoEquilibrium}}
            <div class="equilibrium-item" data-cargo="{{@key}}">
                <div class="cargo-name">{{@key}}</div>
                <div class="equilibrium-bar">
                    <div class="supply-bar" style="width: {{this.supplyPercent}}%" title="Supply: {{this.supply}}">
                        <span class="bar-label">{{this.supply}}</span>
                    </div>
                    <div class="demand-bar" style="width: {{this.demandPercent}}%" title="Demand: {{this.demand}}">
                        <span class="bar-label">{{this.demand}}</span>
                    </div>
                </div>
                <div class="equilibrium-state {{this.state}}">{{getEquilibriumStateLabel this.state}}</div>
            </div>
            {{/each}}
        </div>
    </div>

    {{!-- Merchant List --}}
    <div class="merchant-section">
        <div class="merchant-header">
            <h3>Available Merchants</h3>
            <div class="merchant-filters">
                <select class="cargo-filter">
                    <option value="">All Cargo Types</option>
                    {{#each availableCargoTypes}}
                    <option value="{{this}}">{{this}}</option>
                    {{/each}}
                </select>
                <select class="merchant-type-filter">
                    <option value="">All Types</option>
                    <option value="producer">Producers (Selling)</option>
                    <option value="seeker">Seekers (Buying)</option>
                </select>
            </div>
        </div>
        
        <div class="merchant-list">
            {{#if merchants}}
                {{#each merchants}}
                <div class="merchant-card {{type}} {{#if availability.desperation.penaltiesApplied}}desperate{{/if}}" 
                     data-merchant-id="{{id}}" data-cargo="{{cargoType}}">
                    
                    <div class="merchant-header">
                        <div class="merchant-basic">
                            <h4 class="cargo-name">{{cargoType}}</h4>
                            <span class="merchant-type">{{capitalize type}}</span>
                            {{#if availability.desperation.penaltiesApplied}}
                            <span class="desperation-badge" title="Desperate merchant - penalties applied">
                                <i class="fas fa-exclamation-triangle"></i> Desperate
                            </span>
                            {{/if}}
                        </div>
                        
                        <div class="merchant-personality">
                            <span class="personality-name" title="{{personality.description}}">
                                {{personality.name}}
                            </span>
                            {{#if specialBehaviors}}
                            <div class="special-behaviors">
                                {{#each specialBehaviors}}
                                <span class="behavior-badge">{{this}}</span>
                                {{/each}}
                            </div>
                            {{/if}}
                        </div>
                    </div>

                    <div class="merchant-details">
                        <div class="quantity-info">
                            <label>Quantity:</label>
                            <span class="quantity-value">{{quantity}} EP</span>
                        </div>
                        
                        <div class="price-info">
                            <label>Price:</label>
                            <div class="price-breakdown">
                                <span class="base-price">{{basePrice}} GC (base)</span>
                                {{#if (ne finalPrice basePrice)}}
                                <span class="final-price">â†’ {{finalPrice}} GC</span>
                                {{/if}}
                            </div>
                            {{#if priceModifiers}}
                            <div class="price-modifiers">
                                {{#each priceModifiers}}
                                <span class="modifier {{type}}" title="{{description}}">
                                    {{name}}: {{value}}
                                </span>
                                {{/each}}
                            </div>
                            {{/if}}
                        </div>
                        
                        <div class="skill-info">
                            <label>Skill:</label>
                            <span class="skill-value">{{skill}}</span>
                            <div class="skill-hint">
                                {{#if (gte skill 70)}}Excellent{{else}}{{#if (gte skill 50)}}Good{{else}}{{#if (gte skill 30)}}Average{{else}}Poor{{/if}}{{/if}}{{/if}}
                            </div>
                        </div>
                    </div>

                    <div class="merchant-actions">
                        {{#if (eq type "producer")}}
                        <div class="buying-controls">
                            <input type="number" class="quantity-input" min="1" max="{{quantity}}" placeholder="Qty" />
                            <button class="buy-partial-btn">Buy Amount</button>
                            <button class="buy-all-btn">Buy All ({{quantity}})</button>
                        </div>
                        {{else}}
                        <div class="selling-controls">
                            <input type="number" class="quantity-input" min="1" placeholder="Qty to sell" />
                            <button class="sell-partial-btn">Sell Amount</button>
                            <button class="sell-all-btn">Sell All Available</button>
                        </div>
                        {{/if}}
                        
                        {{#unless availability.isAvailable}}
                        {{#unless availability.desperation.available}}
                        <div class="desperation-controls">
                            <button class="desperation-reroll-btn" data-merchant-id="{{id}}">
                                <i class="fas fa-dice"></i> Desperate Reroll
                            </button>
                            <div class="desperation-warning">
                                <small>+{{../desperationConfig.priceModifier}}% price, -{{../desperationConfig.quantityReduction}}% quantity</small>
                            </div>
                        </div>
                        {{/unless}}
                        {{/unless}}
                    </div>
                </div>
                {{/each}}
            {{else}}
            <div class="no-merchants">
                <i class="fas fa-store-slash"></i>
                <p>No merchants available. Try checking availability or visiting a different settlement.</p>
            </div>
            {{/if}}
        </div>
    </div>

    {{!-- Transaction Log --}}
    <div class="transaction-section">
        <div class="transaction-header">
            <h3>Transaction Log</h3>
            <div class="log-controls">
                <button class="clear-log-btn">Clear Log</button>
                <button class="export-log-btn">Export to Chat</button>
            </div>
        </div>
        
        <div class="transaction-list">
            {{#if transactionLog}}
                {{#each transactionLog}}
                <div class="transaction-item {{type}}">
                    <div class="transaction-info">
                        <span class="transaction-type">{{capitalize type}}</span>
                        <span class="cargo-info">{{cargoType}} x{{quantity}}</span>
                        <span class="merchant-info">from {{merchantId}}</span>
                        <span class="price-info">{{totalPrice}} GC</span>
                    </div>
                    <div class="transaction-meta">
                        <span class="timestamp">{{formatTime timestamp}}</span>
                        {{#if canUndo}}
                        <button class="undo-btn" data-transaction-id="{{id}}">
                            <i class="fas fa-undo"></i> Undo
                        </button>
                        {{/if}}
                    </div>
                </div>
                {{/each}}
            {{else}}
            <div class="no-transactions">
                <p>No transactions yet.</p>
            </div>
            {{/if}}
        </div>
    </div>
</div>

{{!-- Desperation Confirmation Modal --}}
<div class="desperation-modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Desperate Reroll</h3>
            <button class="modal-close"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <p>This merchant is desperate to make a deal. A reroll is possible, but comes with penalties:</p>
            <ul class="penalty-list">
                <li><strong>Price increase:</strong> +{{desperationConfig.priceIncrease}}%</li>
                <li><strong>Quantity reduction:</strong> -{{desperationConfig.quantityReduction}}%</li>
                <li><strong>Skill penalty:</strong> -{{desperationConfig.skillPenalty}}%</li>
            </ul>
            <p>Do you want to attempt the desperate reroll?</p>
        </div>
        <div class="modal-footer">
            <button class="cancel-btn">Cancel</button>
            <button class="confirm-reroll-btn">
                <i class="fas fa-dice"></i> Attempt Reroll
            </button>
        </div>
    </div>
</div>