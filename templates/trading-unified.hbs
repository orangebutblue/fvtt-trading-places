{{!-- WFRP Trading Places - Unified Modern UI Template --}}
<div class="trading-app">
    <!-- Header -->
    <div class="app-header">
        <div class="app-title">
            <i class="fas fa-coins"></i>
            <h1>Trading Places</h1>
        </div>
        <div class="header-controls">
            <div class="season-control">
                <label>Current Season:</label>
                <select id="season-select">
                    <option value="spring" {{#if (eq currentSeason "spring")}}selected{{/if}}>Spring</option>
                    <option value="summer" {{#if (eq currentSeason "summer")}}selected{{/if}}>Summer</option>
                    <option value="autumn" {{#if (eq currentSeason "autumn")}}selected{{/if}}>Autumn</option>
                    <option value="winter" {{#if (eq currentSeason "winter")}}selected{{/if}}>Winter</option>
                </select>
            </div>
        </div>
        {{#if debugLoggingEnabled}}
        <div class="debug-toggle">
            <label>
                <input type="checkbox" id="debug-mode" checked>
                <i class="fas fa-bug"></i>
                Debug Logging
            </label>
        </div>
        {{/if}}
    </div>

    <!-- Main Content -->
    <div class="app-content">
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Location Selection -->
            <div class="section">
                <h2 class="section-title">
                    <i class="fas fa-map-marker-alt"></i>
                    Location
                </h2>
                
                <div class="form-group">
                    <label class="form-label">Region</label>
                    <select class="form-select" id="region-select">
                        <option value="">Select a region...</option>
                        <option value="Reikland" {{#if (eq selectedRegion "Reikland")}}selected{{/if}}>Reikland</option>
                        <option value="Middenland" {{#if (eq selectedRegion "Middenland")}}selected{{/if}}>Middenland</option>
                        <option value="Nordland" {{#if (eq selectedRegion "Nordland")}}selected{{/if}}>Nordland</option>
                        <option value="Ostland" {{#if (eq selectedRegion "Ostland")}}selected{{/if}}>Ostland</option>
                        <option value="Ostermark" {{#if (eq selectedRegion "Ostermark")}}selected{{/if}}>Ostermark</option>
                        <option value="Stirland" {{#if (eq selectedRegion "Stirland")}}selected{{/if}}>Stirland</option>
                        <option value="Averland" {{#if (eq selectedRegion "Averland")}}selected{{/if}}>Averland</option>
                        <option value="Wissenland" {{#if (eq selectedRegion "Wissenland")}}selected{{/if}}>Wissenland</option>
                        <option value="Talabecland" {{#if (eq selectedRegion "Talabecland")}}selected{{/if}}>Talabecland</option>
                        <option value="Hochland" {{#if (eq selectedRegion "Hochland")}}selected{{/if}}>Hochland</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Settlement</label>
                    <select class="form-select" id="settlement-select" {{#unless selectedRegion}}disabled{{/unless}}>
                        {{#if selectedRegion}}
                            <option value="">Select a settlement...</option>
                            {{#each settlements}}
                            <option value="{{name}}" {{#if (eq ../selectedSettlement.name name)}}selected{{/if}}>{{name}}</option>
                            {{/each}}
                        {{else}}
                            <option value="">Select a region first...</option>
                        {{/if}}
                    </select>
                </div>
            </div>

            <!-- Settlement Info Section -->
            {{#if selectedSettlement}}
            <div class="section">
                <h2 class="section-title">
                    <i class="fas fa-info-circle"></i>
                    Settlement Info
                </h2>
                <div class="settlement-display">
                    <h3>{{selectedSettlement.name}}</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Region</div>
                            <div class="info-value">{{selectedSettlement.region}}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Size</div>
                            <div class="info-value">{{getSizeDescription selectedSettlement.size}} ({{getSizeRating selectedSettlement.size}})</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Wealth</div>
                            <div class="info-value">{{getWealthDescription selectedSettlement.wealth}} ({{selectedSettlement.wealth}})</div>
                        </div>
                        {{#if selectedSettlement.population}}
                        <div class="info-item">
                            <div class="info-label">Population</div>
                            <div class="info-value">{{formatNumber selectedSettlement.population}}</div>
                        </div>
                        {{/if}}
                    </div>
                    {{#if (isTradeSettlement selectedSettlement)}}
                    <div class="trade-badge">Major Trade Center</div>
                    {{/if}}
                </div>
            </div>
            {{/if}}

            {{#if isGM}}
            <!-- GM Tools Section -->
            <div class="section gm-tools-section">
                <h2 class="section-title">
                    <i class="fas fa-tools"></i>
                    GM Tools
                </h2>
                <div class="gm-tools">
                    <button class="btn btn-secondary" id="open-data-management" title="Data Management (GM Only)" style="width: 100%;">
                        <i class="fas fa-database"></i>
                        Data Management
                    </button>
                </div>
            </div>
            {{/if}}


        </div>

        <!-- Main Panel -->
        <div class="main-panel">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" data-tab="buying">
                    <i class="fas fa-shopping-cart"></i>
                    Buying
                </button>
                <button class="tab" data-tab="selling">
                    <i class="fas fa-hand-holding-usd"></i>
                    Selling
                </button>
                <button class="tab" data-tab="cargo">
                    <i class="fas fa-boxes"></i>
                    Cargo
                </button>
                <button class="tab" data-tab="history">
                    <i class="fas fa-history"></i>
                    History
                </button>
            </div>

            <!-- Buying Tab -->
            <div class="tab-content active" id="buying-tab">
                <!-- Error Display -->
                <div class="error-display" id="buying-error-display">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="buying-error-message"></span>
                </div>

                {{#if selectedSettlement}}
                <!-- Settlement Information Section -->
                <div class="settlement-info">
                    <section class="settlement-info-section">
                        <h5><i class="fas fa-info-circle"></i> Settlement Information</h5>
                                                <div class="calculation-breakdown">
                            {{#if selectedSettlement.flags}}
                            <div class="settlement-flags">
                                <strong>Settlement Characteristics:</strong>
                                <ul class="characteristics-list">
                                    {{#each selectedSettlement.flags}}
                                    <li>{{this}} <span class="info-indicator" data-info-tooltip="{{getFlagDescription this}}">?</span></li>
                                    {{/each}}
                                </ul>
                            </div>
                            {{/if}}
                            <div class="slot-info">
                                <strong>Available Slots:</strong>
                                <span class="slot-value">{{calculateCargoSlots selectedSettlement currentSeason}} <span class="info-indicator" data-info-tooltip="Settlement Size: {{getSizeDescription selectedSettlement.size}} ({{getSizeRating selectedSettlement.size}})
Settlement Wealth: {{selectedSettlement.wealth}}
{{#if selectedSettlement.population}}Population: {{formatNumber selectedSettlement.population}}
{{/if}}
Season: {{currentSeason}}

Slot Calculation:
{{#each (getCargoSlotsCalculationBreakdown selectedSettlement currentSeason)}}‚Ä¢ {{this.label}} (current: {{this.current}})
{{/each}}">?</span></span>
                            </div>
                            <div class="cargo-distribution-chart">
                                <strong>Cargo Spawn Distribution:</strong>
                                <div class="pie-chart-container">
                                    <canvas id="buying-cargo-distribution-chart" width="200" height="200"></canvas>
                                </div>
                                <div class="chart-legend" id="buying-chart-legend"></div>
                            </div>
                        </div>
                    </section>
                </div>
                {{/if}}

                <!-- Check Availability Section -->
                <div class="availability-check-section">
                    <button class="btn btn-primary check-availability" id="check-availability" style="width: 100%; margin-bottom: 24px;" {{#unless hasSettlement}}disabled{{/unless}}>
                        <i class="fas fa-search"></i>
                        Check Cargo Availability
                    </button>
                </div>

                <!-- Availability Results Section -->
                <div class="availability-section">
                    <div class="availability-results" id="availability-results" style="display: none;">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Negotiate Button -->
                <div class="buying-actions" {{#unless selectedSettlement}}style="display: none;"{{/unless}}>
                    <button class="btn btn-success" id="negotiate-buy" style="display: none;">
                        <i class="fas fa-handshake"></i>
                        Negotiate
                    </button>
                </div>

                <!-- Cargo Grid -->
                <div class="cargo-grid" id="buying-cargo-grid" style="display: none;">
                    <!-- Cargo cards will be populated by JavaScript -->
                </div>
            </div>

            <!-- Selling Tab -->
            <div class="tab-content" id="selling-tab">
                <!-- Error Display -->
                <div class="error-display" id="selling-error-display">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="selling-error-message"></span>
                </div>

                {{#if selectedSettlement}}
                <!-- Settlement Information Section -->
                <div class="settlement-info">
                    <section class="settlement-info-section">
                        <h5><i class="fas fa-info-circle"></i> Settlement Information</h5>
                                                <div class="calculation-breakdown">
                            {{#if selectedSettlement.flags}}
                            <div class="settlement-flags">
                                <strong>Settlement Characteristics:</strong>
                                <ul class="characteristics-list">
                                    {{#each selectedSettlement.flags}}
                                    <li>{{this}} <span class="info-indicator" data-info-tooltip="{{getFlagDescription this}}">?</span></li>
                                    {{/each}}
                                </ul>
                            </div>
                            {{/if}}
                            <div class="slot-info">
                                <strong>Available Slots:</strong>
                                <span class="slot-value">{{calculateCargoSlots selectedSettlement currentSeason}} <span class="info-indicator" data-info-tooltip="Settlement Size: {{getSizeDescription selectedSettlement.size}} ({{getSizeRating selectedSettlement.size}})
Settlement Wealth: {{selectedSettlement.wealth}}
{{#if selectedSettlement.population}}Population: {{formatNumber selectedSettlement.population}}
{{/if}}
Season: {{currentSeason}}

Slot Calculation:
{{#each (getCargoSlotsCalculationBreakdown selectedSettlement currentSeason)}}‚Ä¢ {{this.label}} (current: {{this.current}})
{{/each}}">?</span></span>
                            </div>
                            <div class="cargo-distribution-chart">
                                <strong>Buyer Demand Distribution:</strong>
                                <div class="pie-chart-container">
                                    <canvas id="selling-cargo-distribution-chart" width="200" height="200"></canvas>
                                </div>
                                <div class="chart-legend" id="selling-chart-legend"></div>
                            </div>
                        </div>
                    </section>
                </div>
                {{/if}}

                <!-- Current Cargo Display - Minimal -->
                <div class="current-cargo-section">
                    <h6><i class="fas fa-boxes"></i> Current Cargo</h6>
                    {{#if currentCargo.length}}
                    <div class="cargo-minimal-list">
                        {{#each currentCargo}}
                        <div class="cargo-minimal-item" data-category="{{category}}" data-contraband="{{contraband}}">
                            <span class="cargo-minimal-name">{{cargo}}</span>
                            <span class="cargo-minimal-quantity">{{quantity}} EP</span>
                        </div>
                        {{/each}}
                    </div>
                    {{else}}
                    <div class="empty-cargo-notice">
                        <i class="fas fa-box-open"></i>
                        <p>No cargo available to sell</p>
                        <div class="sub-text">Purchase cargo from the buying tab first</div>
                    </div>
                    {{/if}}
                </div>

                <!-- Look for Sellers Button -->
                <div class="look-for-sellers-section">
                    <button class="btn btn-primary look-for-sellers" id="look-for-sellers" style="width: 100%; margin: 24px 0;" {{#unless (and selectedSettlement currentCargo.length)}}disabled{{/unless}}>
                        <i class="fas fa-search"></i>
                        Look for Sellers
                    </button>
                </div>

                <!-- Seller Results Section -->
                <div class="seller-results-section">
                    <div class="seller-results" id="seller-results" style="display: none;">
                        <!-- Seller offer cards will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Negotiate Button -->
                <div class="selling-actions" {{#unless selectedSettlement}}style="display: none;"{{/unless}}>
                    <button class="btn btn-success" id="negotiate-sell" style="display: none;">
                        <i class="fas fa-handshake"></i>
                        Negotiate Sale
                    </button>
                </div>

                <!-- Empty State -->
                {{#unless selectedSettlement}}
                <div class="empty-state" id="selling-empty-state">
                    <i class="fas fa-map-marker-alt"></i>
                    <p>Select a settlement to start selling</p>
                    <div class="sub-text">Choose a settlement to find buyers for your cargo</div>
                </div>
                {{/unless}}
            </div>

            <!-- Cargo Tab -->
            <div class="tab-content" id="cargo-tab" style="display: none;">
                <div class="cargo-header">
                    <div class="capacity-section">
                        <div class="capacity-controls">
                            <label for="cargo-capacity">Maximum Capacity:</label>
                            <input type="number" id="cargo-capacity" value="{{cargoCapacity}}" min="0" step="1" />
                            <span class="capacity-unit">EP</span>
                        </div>
                        <div class="capacity-display">
                            <div class="capacity-bar-container">
                                <div class="capacity-bar">
                                    <div class="capacity-used" style="width: {{capacityPercentage}}%"></div>
                                </div>
                                <div class="capacity-text">
                                    <span class="current-load {{#if isOverCapacity}}over-capacity{{/if}}">{{currentLoad}}</span>
                                    <span class="capacity-separator">/</span>
                                    <span class="max-capacity">{{cargoCapacity}}</span>
                                    <span class="capacity-unit">EP</span>
                                    {{#if isOverCapacity}}
                                        <span class="over-capacity-warning">‚ö†Ô∏è Over Capacity</span>
                                    {{/if}}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Collapsible Add Cargo Section -->
                <div class="add-cargo-section">
                    <button class="add-cargo-toggle" type="button">
                        <i class="fas fa-plus-circle"></i>
                        <span>Add cargo</span>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </button>
                    
                    <div class="add-cargo-form collapsed">
                        <div class="add-cargo-grid">
                            <div class="add-cargo-row">
                                <input type="text" id="add-cargo-name" placeholder="Cargo name" list="add-cargo-datalist" />
                                <datalist id="add-cargo-datalist">
                                    <!-- Cargo options will be populated dynamically -->
                                </datalist>
                                <select id="add-cargo-category">
                                    <option value="">Category</option>
                                    <!-- Categories will be populated dynamically from cargo types -->
                                </select>
                            </div>
                            
                            <div class="add-cargo-row">
                                <input type="number" id="add-cargo-quantity" placeholder="EP" min="1" step="1" />
                                <input type="number" id="add-cargo-price" placeholder="Total price (optional)" step="0.01" min="0" />
                            </div>
                            
                            <div class="add-cargo-row">
                                <input type="text" id="add-cargo-settlement" placeholder="Settlement (optional)" value="{{#if selectedSettlement}}{{selectedSettlement.name}}{{/if}}" />
                                <select id="add-cargo-season">
                                    <option value="spring" {{#if (eq currentSeason 'spring')}}selected{{/if}}>Spring</option>
                                    <option value="summer" {{#if (eq currentSeason 'summer')}}selected{{/if}}>Summer</option>
                                    <option value="autumn" {{#if (eq currentSeason 'autumn')}}selected{{/if}}>Autumn</option>
                                    <option value="winter" {{#if (eq currentSeason 'winter')}}selected{{/if}}>Winter</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="add-cargo-actions">
                            <span class="total-cost-preview">Total cost: <strong>--</strong></span>
                            <button type="button" class="add-cargo-btn">Add Cargo</button>
                        </div>
                    </div>
                </div>

                <div class="cargo-list">
                    {{#if currentCargo.length}}
                        {{#each currentCargo}}
                        <div class="transaction-card purchase" data-cargo-id="{{id}}">
                            <div class="transaction-header">
                                <div class="cargo-info">
                                    <span class="cargo-name">{{cargo}}</span>
                                    <span class="cargo-category">{{category}}</span>
                                    {{#if contraband}}
                                        <span class="contraband-badge">Contraband</span>
                                    {{/if}}
                                </div>
                                <div class="transaction-summary">
                                    <div class="quantity-display">{{quantity}} EP</div>
                                    <div class="cost-display">{{#if formattedTotalCost}}{{formattedTotalCost}}{{else if totalCost}}{{totalCost}} GC{{else}}?{{/if}}</div>
                                </div>
                                <div class="transaction-actions">
                                    <button class="sell-cargo-btn" data-cargo-id="{{id}}" title="Sell cargo">
                                        <i class="fas fa-coins"></i>
                                    </button>
                                    <button class="delete-cargo-btn" data-cargo-id="{{id}}" title="Remove cargo">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="transaction-body">
                                <div class="transaction-details">
                                    <span class="detail-compact">{{quantity}} EP √ó {{#if formattedPricePerEP}}{{formattedPricePerEP}}{{else if pricePerEP}}{{pricePerEP}} GC{{else}}?{{/if}}</span>
                                </div>
                                <div class="transaction-meta">
                                    <span class="meta-compact">
                                        <i class="fas fa-map-marker-alt"></i>{{settlement}}
                                    </span>
                                    <span class="meta-compact">
                                        <i class="fas fa-calendar"></i>{{season}}
                                    </span>
                                    <span class="meta-compact">
                                        <i class="fas fa-clock"></i>{{formatDate date}}
                                    </span>
                                </div>
                            </div>
                        </div>
                        {{/each}}
                    {{else}}
                        <div class="empty-cargo">
                            <div class="empty-cargo-icon">üì¶</div>
                            <div class="empty-cargo-text">No cargo currently loaded</div>
                            <div class="empty-cargo-subtitle">Purchase cargo from the buying tab to see it here</div>
                        </div>
                    {{/if}}
                </div>
            </div>

            <!-- History Tab -->
            <div class="tab-content" id="history-tab">
                <!-- Collapsible Manual Entry -->
                <div class="manual-entry-section">
                    <button class="manual-entry-toggle" type="button">
                        <i class="fas fa-plus-circle"></i>
                        <span>Add manual transaction</span>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </button>
                    
                    <div class="manual-entry-form collapsed">
                        <div class="manual-entry-grid">
                            <div class="manual-entry-row">
                                <input type="text" id="manual-cargo" placeholder="Cargo name" list="cargo-datalist" />
                                <datalist id="cargo-datalist">
                                    <!-- Cargo options will be populated dynamically -->
                                </datalist>
                                <select id="manual-category">
                                    <option value="">Category</option>
                                    <!-- Categories will be populated dynamically from cargo types -->
                                </select>
                            </div>
                            
                            <div class="manual-entry-row">
                                <input type="number" id="manual-quantity" placeholder="EP" min="1" />
                                <input type="number" id="manual-total-cost" placeholder="Total cost" step="0.01" min="0" />
                                <select id="manual-transaction-type">
                                    <option value="purchase">Purchase</option>
                                    <option value="sale">Sale</option>
                                </select>
                            </div>
                            
                            <div class="manual-entry-row">
                                <label><input type="checkbox" id="manual-contraband"> Contraband</label>
                            </div>
                            
                            <div class="manual-entry-row">
                                <input type="text" id="manual-settlement" placeholder="Settlement" value="{{#if selectedSettlement}}{{selectedSettlement.name}}{{/if}}" />
                                <select id="manual-season">
                                    <option value="spring" {{#if (eq currentSeason 'spring')}}selected{{/if}}>Spring</option>
                                    <option value="summer" {{#if (eq currentSeason 'summer')}}selected{{/if}}>Summer</option>
                                    <option value="autumn" {{#if (eq currentSeason 'autumn')}}selected{{/if}}>Autumn</option>
                                    <option value="winter" {{#if (eq currentSeason 'winter')}}selected{{/if}}>Winter</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="manual-entry-actions">
                            <span class="price-preview">Price per EP: <strong>--</strong></span>
                            <button type="button" class="add-manual-transaction-btn">Add Transaction</button>
                        </div>
                    </div>
                </div>

                {{#if transactionHistory.length}}
                <div class="transaction-list">
                    {{#each transactionHistory}}
                    <div class="transaction-card {{#if isSale}}sale{{else}}purchase{{/if}}" data-transaction-index="{{@index}}">
                        <div class="transaction-header">
                            <div class="cargo-info">
                                <span class="cargo-name">{{cargo}}</span>
                                <span class="cargo-category">{{category}}</span>
                            </div>
                            <div class="transaction-summary">
                                <div class="quantity-display">{{quantity}} EP</div>
                                <div class="cost-display">{{#if formattedTotalCost}}{{formattedTotalCost}}{{else if totalCost}}{{totalCost}} GC{{else}}?{{/if}}</div>
                            </div>
                            <div class="transaction-actions">
                                <button class="delete-transaction-btn" data-transaction-index="{{@index}}" title="Delete transaction">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="transaction-body">
                            <div class="transaction-details">
                                <span class="detail-compact">{{quantity}} EP √ó {{#if formattedPricePerEP}}{{formattedPricePerEP}}{{else if pricePerEP}}{{pricePerEP}} GC{{else}}?{{/if}}</span>
                                {{#if discountPercent}}
                                <span class="detail-discount">{{#if (gt discountPercent 0)}}+{{/if}}{{discountPercent}}%</span>
                                {{/if}}
                            </div>
                            <div class="transaction-meta">
                                <span class="meta-compact">
                                    <i class="fas fa-map-marker-alt"></i>{{settlement}}
                                </span>
                                <span class="meta-compact">
                                    <i class="fas fa-calendar"></i>{{season}}
                                </span>
                                <span class="meta-compact">
                                    <i class="fas fa-clock"></i>{{formatDate date}}
                                </span>
                            </div>
                        </div>
                    </div>
                    {{/each}}
                </div>
                {{else}}
                <div class="empty-state">
                    <i class="fas fa-history"></i>
                    <p>No transactions yet</p>
                    <div class="sub-text">Your trading history will appear here</div>
                </div>
                {{/if}}
            </div>
        </div>
    </div>
</div>